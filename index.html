<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clawdbot Pro Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #020617; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .task-card { background: #1e293b; border: 1px solid #334155; border-radius: 1.5rem; transition: transform 0.2s; position: relative; }
        .task-card:active { transform: scale(0.98); }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; font-size: 16px; }
        
        /* Chips & Colors */
        .chip { display: inline-flex; align-items: center; justify-content: center; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; min-height: 32px; }
        .status-unklar { background: #fef08a; color: #854d0e; }
        .status-offen { background: #3b82f6; color: #ffffff; }
        .status-arbeit { background: #a855f7; color: #ffffff; }
        .status-blockiert { background: #ef4444; color: #ffffff; }
        .status-erledigt { background: #22c55e; color: #ffffff; }
        .plan-chip { background: #334155; color: #94a3b8; border: 1px solid #475569; }
        .cat-chip { background: rgba(59, 130, 246, 0.1); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.2); }
        .owner-chip { background: #0f172a; color: #64748b; border: 1px solid #334155; }

        /* Drawer System */
        .drawer { position: fixed; bottom: -100%; left: 0; right: 0; background: #1e293b; border-radius: 2rem 2rem 0 0; z-index: 150; transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 24px; border-top: 1px solid #334155; max-height: 80vh; overflow-y: auto; }
        .drawer.open { bottom: 0; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 140; backdrop-blur: 4px; }
        .overlay.open { display: block; }

        .fab { position: fixed; bottom: 32px; right: 24px; width: 64px; height: 64px; border-radius: 20px; background: #2563eb; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); z-index: 100; }
        .search-sticky { position: sticky; top: 0; z-index: 60; background: rgba(2, 6, 23, 0.9); backdrop-blur: 16px; padding: 16px 20px; margin: 0 -20px; border-bottom: 1px solid #1e293b; }
    </style>
</head>
<body class="text-slate-100 p-5 pb-32">

    <!-- 1.1 Header -->
    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-xs font-black tracking-[0.2em] text-slate-500 uppercase">Clawdbot Ops Pro</h1>
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                <span class="text-[10px] font-bold text-green-500 uppercase">System Live</span>
            </div>
        </div>
        <button onclick="openDrawer('filterDrawer')" class="p-3 bg-slate-800 rounded-2xl border border-slate-700">
            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
        </button>
    </header>

    <!-- 3.1 Suche -->
    <div class="search-sticky mb-6">
        <div class="relative">
            <input type="text" id="global-search" oninput="handleSearch(this.value)" placeholder="Aufgaben, Owner, Tags..." class="w-full bg-slate-800/50 border border-slate-700 rounded-2xl py-4 pl-12 outline-none focus:ring-2 focus:ring-blue-500/50 transition">
            <svg class="w-5 h-5 text-slate-500 absolute left-4 top-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
    </div>

    <!-- 7. Performance -->
    <section class="grid grid-cols-2 gap-4 mb-8">
        <div class="bg-slate-800/40 p-5 rounded-3xl border border-slate-800">
            <div class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Erledigt Heute</div>
            <div id="perf-today" class="text-3xl font-black text-green-500">0</div>
        </div>
        <div class="bg-slate-800/40 p-5 rounded-3xl border border-slate-800">
            <div class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Offene Tasks</div>
            <div id="perf-open" class="text-3xl font-black text-blue-500">0</div>
        </div>
    </section>

    <!-- 2. Task List -->
    <div id="task-list" class="space-y-4">
        <div class="py-20 text-center animate-pulse text-slate-600 font-bold uppercase tracking-widest text-xs">Synchronisiere Notion Data...</div>
    </div>

    <!-- 1.2 FAB -->
    <button onclick="openDrawer('addDrawer')" class="fab">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
    </button>

    <!-- Filter Drawer -->
    <div id="filterDrawer" class="drawer">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black">Filter & Sortierung</h2>
            <button onclick="closeDrawer()" class="text-slate-500 text-2xl">&times;</button>
        </div>
        <div class="space-y-6">
            <div>
                <label class="block text-[10px] font-black uppercase text-slate-500 mb-3">Sortierung</label>
                <select id="sort-logic" onchange="renderTasks(allTasks)" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4">
                    <option value="overdue">Überfällig zuerst</option>
                    <option value="today">Heute zuerst</option>
                    <option value="newest">Neueste zuerst</option>
                </select>
            </div>
            <button onclick="closeDrawer()" class="w-full bg-blue-600 py-4 rounded-2xl font-black">Anwenden</button>
        </div>
    </div>

    <!-- Detail/Add Drawer -->
    <div id="addDrawer" class="drawer">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black">Neuer Smart Task</h2>
            <button onclick="closeDrawer()" class="text-slate-500 text-2xl">&times;</button>
        </div>
        <div class="space-y-5">
            <input type="text" id="m-name" class="w-full bg-slate-900 border border-slate-700 rounded-2xl p-4" placeholder="Titel der Aufgabe...">
            <button onclick="submitTask()" class="w-full bg-blue-600 py-4 rounded-2xl font-black">Task in Notion anlegen</button>
        </div>
    </div>

    <div id="overlay" class="overlay" onclick="closeDrawer()"></div>

    <script>
        const TASK_DB_ID = "2f88adfd364b81d9a1acea15263d4885";
        const STATS_DB_ID = "2f88adfd364b81c08fa2d019470cb1e5";
        let allTasks = [];
        let searchTimeout;

        const openDrawer = (id) => { document.getElementById(id).classList.add('open'); document.getElementById('overlay').classList.add('open'); };
        const closeDrawer = () => { document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open')); document.getElementById('overlay').classList.remove('open'); };

        const getStatusClass = (s) => {
            const map = { 'Unklar': 'status-unklar', 'Offen': 'status-offen', 'In Arbeit': 'status-arbeit', 'Blockiert': 'status-blockiert', 'Erledigt': 'status-erledigt' };
            return map[s] || 'bg-slate-700';
        };

        // 3.1 Debounce Suche (250ms)
        function handleSearch(q) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = q.toLowerCase();
                const filtered = allTasks.filter(t => {
                    const p = t.properties;
                    return (p.Aufgabe?.title[0]?.plain_text || "").toLowerCase().includes(query) ||
                           (p.Typ?.select?.name || "").toLowerCase().includes(query) ||
                           (p.Zuständig?.select?.name || "").toLowerCase().includes(query);
                });
                renderTasks(filtered);
            }, 250);
        }

        async function update() {
            try {
                const res = await fetch(`/.netlify/functions/notion-proxy?db_id=${TASK_DB_ID}`);
                const data = await res.json();
                allTasks = data.results || [];
                
                // 7. Performance Logic
                const today = new Date().toISOString().split('T')[0];
                const doneToday = allTasks.filter(t => t.properties.Status?.select?.name === 'Erledigt' && t.last_edited_time.startsWith(today)).length;
                const openTasks = allTasks.filter(t => t.properties.Status?.select?.name !== 'Erledigt').length;
                
                document.getElementById('perf-today').innerText = doneToday;
                document.getElementById('perf-open').innerText = openTasks;
                
                renderTasks(allTasks);
            } catch (e) { console.error(e); }
        }

        function renderTasks(tasks) {
            // 5. Sortierung
            const sortVal = document.getElementById('sort-logic').value;
            let sorted = [...tasks];
            if (sortVal === 'overdue') {
                const today = new Date().toISOString().split('T')[0];
                sorted.sort((a, b) => {
                    const dA = a.properties.Fällig?.date?.start || "9999";
                    const dB = b.properties.Fällig?.date?.start || "9999";
                    return dA.localeCompare(dB);
                });
            }

            document.getElementById('task-list').innerHTML = sorted.map(t => {
                const p = t.properties;
                const title = p.Aufgabe?.title[0]?.plain_text || "Unbenannt";
                const status = p.Status?.select?.name || "Offen";
                const plan = p.Intervall?.select?.name || "Einmalig";
                const cat = p.Typ?.select?.name || "Allgemein";
                const owner = p.Zuständig?.select?.name || "Molti";
                const date = p.Fällig?.date?.start ? new Date(p.Fällig.date.start).toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit'}) : "-";

                return `
                    <div class="task-card p-6" onclick="alert('Detailansicht: ${title}')">
                        <h3 class="line-clamp-2 text-white font-bold mb-4 pr-10">${title}</h3>
                        
                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="chip ${getStatusClass(status)}">${status}</span>
                            <span class="chip plan-chip">${plan}</span>
                            <span class="chip cat-chip">${cat}</span>
                            <span class="chip owner-chip">${owner.split(' ')[0]}</span>
                        </div>

                        <div class="flex items-center justify-between pt-4 border-t border-slate-700/50">
                            <div class="flex items-center gap-1.5 text-[10px] text-slate-500 font-bold uppercase tracking-wider">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                ${date}
                            </div>
                            <div class="flex gap-3 text-slate-600">
                                <div class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.414a4 4 0 00-5.656-5.656l-6.415 6.415a6 6 0 108.486 8.486L20.5 13"></path></svg><span class="text-[9px] font-black">0</span></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join("");
        }

        async function submitTask() {
            const name = document.getElementById('m-name').value;
            if (name.length < 3) return;
            const res = await fetch(`/.netlify/functions/notion-proxy?db_id=${TASK_DB_ID}`, {
                method: 'POST',
                body: JSON.stringify({ properties: { "Aufgabe": { "title": [{ "text": { "content": name } }] } } })
            });
            if (res.ok) { closeDrawer(); document.getElementById('m-name').value=''; update(); }
        }

        update();
        setInterval(update, 60000);
    </script>
</body>
</html>
